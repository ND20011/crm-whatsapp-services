<div class="dashboard-container">
  <!-- Welcome Section -->
  <div class="welcome-section">
    <h2 class="welcome-title">
      Â¡Bienvenido! ðŸ‘‹
    </h2>
    <p class="welcome-subtitle">
      {{ currentUser()?.company_name || currentUser()?.client_code }}
    </p>
    <button class="btn btn-outline-primary refresh-btn" (click)="refreshData()">
      <i class="fas fa-sync-alt" [class.fa-spin]="isRefreshing()"></i>
      Actualizar datos
    </button>
  </div>

  <!-- Main Content -->
  <main class="dashboard-main">
    <!-- Loading State -->
    @if (isLoading()) {
      <div class="loading-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando estadÃ­sticas...</p>
      </div>
    } @else {
      <!-- Stats Cards -->
      <div class="stats-grid">
            <!-- Conversations Card -->
            <div class="stat-card">
              <div class="stat-icon conversations">
                <i class="fas fa-comments"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-number">{{ messageStats()?.active_conversations || 0 }}</h3>
                <p class="stat-label">Conversaciones Activas</p>
                <div class="stat-badges">
                  @if (botStatus()?.total_conversations) {
                    <span class="stat-badge total">
                      {{ botStatus()?.total_conversations }} total
                    </span>
                  }
                  @if (getWhatsAppStats()?.total_conversations) {
                    <span class="stat-badge whatsapp">
                      <i class="fab fa-whatsapp"></i>
                      {{ getWhatsAppStats()?.total_conversations }} WhatsApp
                    </span>
                  }
                </div>
              </div>
            </div>

            <!-- Messages Card -->
            <div class="stat-card">
              <div class="stat-icon messages">
                <i class="fas fa-envelope"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-number">{{ messageStats()?.unread_messages || 0 }}</h3>
                <p class="stat-label">Mensajes Sin Leer</p>
                <div class="stat-badges">
                  <span class="stat-badge today">
                    {{ messageStats()?.total_messages || 0 }} total
                  </span>
                  @if (getWhatsAppStats()?.total_messages) {
                    <span class="stat-badge whatsapp">
                      <i class="fab fa-whatsapp"></i>
                      {{ getWhatsAppStats()?.total_messages }} WhatsApp
                    </span>
                  }
                </div>
              </div>
            </div>

            <!-- Bot Status Card -->
            <div class="stat-card">
              <div class="stat-icon bot" [class.active]="isBotActive()">
                <i class="fas fa-robot"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-number">{{ botStatus()?.bot_enabled_percentage || 0 }}%</h3>
                <p class="stat-label">Bot Activado</p>
                <span class="stat-badge" [class]="isBotActive() ? 'active' : 'inactive'">
                  {{ isBotActive() ? 'Activo' : 'Inactivo' }}
                </span>
              </div>
            </div>

            <!-- Bot Messages Card -->
            <div class="stat-card">
              <div class="stat-icon responses">
                <i class="fas fa-reply"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-number">{{ getTotalBotMessages() }}</h3>
                <p class="stat-label">Mensajes del Bot</p>
                <div class="stat-badges">
                  <span class="stat-badge total">
                    {{ messageStats()?.manual_messages || 0 }} manuales
                  </span>
                  @if (getWhatsAppStats()?.bot_messages) {
                    <span class="stat-badge whatsapp">
                      <i class="fab fa-whatsapp"></i>
                      {{ getWhatsAppStats()?.bot_messages }} WhatsApp
                    </span>
                  }
                </div>
              </div>
            </div>

            <!-- Bot Quota Card (Mensajes y Tokens) -->
            <div class="stat-card quota-card">
              <div class="stat-icon quota" [class.exceeded]="botQuota()?.status === 'exceeded'">
                <i class="fas fa-tachometer-alt"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-number">{{ botQuota()?.usage || 0 }}/{{ botQuota()?.limit || 2500 }}</h3>
                <p class="stat-label">Mensajes del Bot</p>
                <div class="stat-badges">
                  <span class="stat-badge" [class]="getQuotaStatusClass()">
                    {{ botQuota()?.remaining || 0 }} disponibles
                  </span>
                  @if (botQuota()?.percentage) {
                    <span class="stat-badge percentage" [class.high]="(botQuota()?.percentage || 0) > 80">
                      {{ botQuota()?.percentage }}% usado
                    </span>
                  }
                </div>
              </div>
            </div>

            <!-- Bot Tokens Card -->
            <div class="stat-card tokens-card">
              <div class="stat-icon tokens" [class.exceeded]="botQuota()?.limits?.tokens?.available === false">
                <i class="fas fa-coins"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-number">{{ botQuota()?.tokenUsage || 0 | number }}/{{ (botQuota()?.tokenLimit || 100000) | number }}</h3>
                <p class="stat-label">Tokens de IA</p>
                <div class="stat-badges">
                  <span class="stat-badge" [class]="getTokenQuotaStatusClass()">
                    {{ (botQuota()?.tokensRemaining || 0) | number }} disponibles
                  </span>
                  @if (botQuota()?.tokenPercentage) {
                    <span class="stat-badge percentage" [class.high]="(botQuota()?.tokenPercentage || 0) > 80">
                      {{ botQuota()?.tokenPercentage }}% usado
                    </span>
                  }
                </div>
              </div>
            </div>

            <!-- WhatsApp Status Card -->
            <div class="stat-card whatsapp-card" [class.refreshing]="isRefreshingWhatsApp()">
              <div class="stat-icon whatsapp" [class]="getWhatsAppStatusColor()">
                <i class="fab fa-whatsapp"></i>
                @if (isRefreshingWhatsApp()) {
                  <div class="refresh-indicator">
                    <i class="fas fa-sync-alt fa-spin"></i>
                  </div>
                }
              </div>
              <div class="stat-content">
                <h3 class="stat-number whatsapp-status">
                  @if (whatsappState()?.isLoading) {
                    <span class="spinner-border spinner-border-sm"></span>
                  } @else {
                    <i class="fas" 
                       [class.fa-check-circle]="isWhatsAppConnected()" 
                       [class.fa-times-circle]="!isWhatsAppConnected()">
                    </i>
                  }
                </h3>
                <p class="stat-label">Estado WhatsApp</p>
                <div class="stat-badges">
                  <span class="stat-badge" [class]="getWhatsAppStatusColor()">
                    {{ getWhatsAppStatusMessage() }}
                  </span>
                  @if (whatsappState()?.phoneNumber) {
                    <span class="stat-badge phone">
                      <i class="fas fa-phone"></i>
                      {{ whatsappState()?.phoneNumber }}
                    </span>
                  }
                  @if (whatsappState()?.session?.last_activity) {
                    <span class="stat-badge activity">
                      <i class="fas fa-clock"></i>
                      {{ getLastActivityTime() }}
                    </span>
                  }
                </div>
              </div>
              <div class="stat-actions">
                @if (canConnectWhatsApp()) {
                  <button class="btn btn-sm btn-success" 
                          (click)="connectWhatsApp()"
                          [disabled]="whatsappState()?.isLoading">
                    <i class="fas fa-plug"></i>
                    Conectar
                  </button>
                }
                @if (canDisconnectWhatsApp()) {
                  <button class="btn btn-sm btn-danger" 
                          (click)="disconnectWhatsApp()"
                          [disabled]="whatsappState()?.isLoading">
                    <i class="fas fa-unlink"></i>
                    Desconectar
                  </button>
                }
                @if (canForceCleanupWhatsApp()) {
                  <button class="btn btn-sm btn-warning" 
                          (click)="forceCleanupWhatsApp()"
                          [disabled]="whatsappState()?.isLoading"
                          title="Limpiar sesiÃ³n completamente para poder reconectar">
                    <i class="fas fa-broom"></i>
                    Force Clean
                  </button>
                }
                <button class="btn btn-sm btn-outline-secondary" 
                        (click)="refreshWhatsAppStatus()"
                        [disabled]="whatsappState()?.isLoading">
                  <i class="fas fa-sync-alt" [class.fa-spin]="whatsappState()?.isLoading"></i>
                  Actualizar
                </button>
              </div>
            </div>
      </div>

      <!-- Push Notifications Panel -->
      <div class="push-notifications-panel collapsible-panel" [class.expanded]="showPushNotifications()">
        <div class="panel-header clickable" (click)="togglePushNotifications()">
          <div class="header-content">
            <h2 class="panel-title">
              <i class="fas fa-bell"></i>
              Notificaciones Push
            </h2>
            <p class="panel-subtitle">
              Configura las notificaciones push para recibir alertas de nuevos mensajes
            </p>
          </div>
          <div class="collapse-toggle">
            <i class="fas" [ngClass]="{
              'fa-chevron-down': !showPushNotifications(),
              'fa-chevron-up': showPushNotifications()
            }"></i>
          </div>
        </div>
        
        <div class="panel-content" [class.expanded]="showPushNotifications()">
          <div class="content-inner">
            <app-push-notification-manager></app-push-notification-manager>
          </div>
        </div>
      </div>

      <!-- Bot Control Panel -->
      <div class="bot-control-panel">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-robot"></i>
            Control del Bot
          </h2>
          <p class="panel-subtitle">
            Gestiona el comportamiento automÃ¡tico del bot de WhatsApp
          </p>
        </div>

        <div class="panel-content">
          <!-- WhatsApp Connection Info -->
          @if (isWhatsAppConnected()) {
            <div class="whatsapp-info-section">
              <h3 class="section-title">
                <i class="fab fa-whatsapp"></i>
                InformaciÃ³n de WhatsApp
              </h3>
              <div class="whatsapp-info-grid">
                @if (whatsappState()?.phoneNumber) {
                  <div class="info-item">
                    <span class="info-label">NÃºmero Conectado:</span>
                    <span class="info-value">
                      <i class="fas fa-phone"></i>
                      {{ whatsappState()?.phoneNumber }}
                    </span>
                  </div>
                }
                @if (whatsappState()?.session?.connected_at) {
                  <div class="info-item">
                    <span class="info-label">Conectado desde:</span>
                    <span class="info-value">
                      <i class="fas fa-calendar"></i>
                      {{ getConnectedSince() }}
                    </span>
                  </div>
                }
                @if (getWhatsAppStats()?.total_messages) {
                  <div class="info-item">
                    <span class="info-label">Mensajes WhatsApp:</span>
                    <span class="info-value">
                      <i class="fas fa-envelope"></i>
                      {{ getWhatsAppStats()?.total_messages }}
                    </span>
                  </div>
                }
                @if (getWhatsAppStats()?.total_conversations) {
                  <div class="info-item">
                    <span class="info-label">Conversaciones WhatsApp:</span>
                    <span class="info-value">
                      <i class="fas fa-comments"></i>
                      {{ getWhatsAppStats()?.total_conversations }}
                    </span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- ConfiguraciÃ³n Global del Bot -->
          <div class="bot-global-config-section">
            <h3 class="section-title">
              <i class="fas fa-cog"></i>
              ConfiguraciÃ³n Global del Bot
            </h3>
            <div class="global-config-card">
              <div class="config-info">
                <div class="config-status">
                  <span class="status-label">Estado del Sistema Bot:</span>
                  <span class="status-badge" [class]="botGloballyEnabled() ? 'enabled' : 'disabled'">
                    <i class="fas" [class.fa-check-circle]="botGloballyEnabled()" [class.fa-times-circle]="!botGloballyEnabled()"></i>
                    {{ botGloballyEnabled() ? 'HABILITADO' : 'DESHABILITADO' }}
                  </span>
                </div>
                <p class="config-description">
                  @if (botGloballyEnabled()) {
                    El bot estÃ¡ habilitado y puede responder automÃ¡ticamente en las conversaciones donde estÃ© activado.
                  } @else {
                    El bot estÃ¡ completamente deshabilitado. No responderÃ¡ automÃ¡ticamente en ninguna conversaciÃ³n.
                  }
                </p>
              </div>
              <div class="config-toggle">
                <div class="toggle-switch" [class.active]="botGloballyEnabled()" (click)="toggleBotGlobally()">
                  <div class="toggle-slider" [class.disabled]="isTogglingBot()">
                    @if (isTogglingBot()) {
                      <span class="spinner-border spinner-border-sm"></span>
                    } @else {
                      <i class="fas" [class.fa-power-off]="botGloballyEnabled()" [class.fa-play]="!botGloballyEnabled()"></i>
                    }
                  </div>
                </div>
                <span class="toggle-label">
                  {{ botGloballyEnabled() ? 'Deshabilitar Bot' : 'Habilitar Bot' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Control por Conversaciones -->
          <div class="bot-conversations-section">
            <h3 class="section-title">
              <i class="fas fa-comments"></i>
              Control por Conversaciones
            </h3>
            
            <div class="conversations-stats">
              <div class="stat-item">
                <span class="stat-number">{{ botStatus()?.bot_enabled_conversations || 0 }}</span>
                <span class="stat-label">Con Bot Activo</span>
              </div>
              <div class="stat-item">
                <span class="stat-number">{{ botStatus()?.bot_disabled_conversations || 0 }}</span>
                <span class="stat-label">Con Bot Desactivado</span>
              </div>
              <div class="stat-item">
                <span class="stat-number">{{ botStatus()?.total_conversations || 0 }}</span>
                <span class="stat-label">Total Conversaciones</span>
              </div>
            </div>

            <div class="conversations-actions">
              <button
                class="btn btn-success"
                [disabled]="isUpdatingBot() || !botGloballyEnabled()"
                (click)="enableBotForAll()"
                title="{{ !botGloballyEnabled() ? 'Primero habilita el bot globalmente' : 'Activar respuestas automÃ¡ticas en todas las conversaciones existentes' }}"
              >
                @if (isUpdatingBot()) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                } @else {
                  <i class="fas fa-robot me-2"></i>
                }
                Activar Bot en Todas las Conversaciones
              </button>

              <button
                class="btn btn-warning"
                [disabled]="isUpdatingBot()"
                (click)="disableBotForAll()"
                title="Desactivar respuestas automÃ¡ticas en todas las conversaciones (solo respuesta manual)"
              >
                @if (isUpdatingBot()) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                } @else {
                  <i class="fas fa-user me-2"></i>
                }
                Desactivar Bot en Todas las Conversaciones
              </button>

              <button
                class="btn btn-info"
                [disabled]="isLoadingDisabledConversations()"
                (click)="toggleDisabledConversations()"
                title="Ver lista de conversaciones donde el bot estÃ¡ desactivado"
              >
                @if (isLoadingDisabledConversations()) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                } @else {
                  <i class="fas fa-list me-2"></i>
                }
                {{ showDisabledConversations() ? 'Ocultar Lista' : 'Ver Conversaciones sin Bot' }}
              </button>
            </div>
          </div>

          <!-- Lista de conversaciones con bot desactivado -->
          @if (showDisabledConversations()) {
            <div class="disabled-conversations-section">
              <div class="section-header">
                <h4 class="section-title">
                  <i class="fas fa-robot-off"></i>
                  Conversaciones con Bot Desactivado
                  @if (disabledBotConversations().length > 0) {
                    <span class="badge bg-warning ms-2">{{ disabledBotConversations().length }}</span>
                  }
                </h4>
                
                @if (disabledBotConversations().length > 0) {
                  <div class="section-actions">
                    <button
                      class="btn btn-sm btn-outline-secondary me-2"
                      (click)="toggleAllConversations()"
                    >
                      <i class="fas fa-check-square"></i>
                      {{ selectedConversations().size === disabledBotConversations().length ? 'Deseleccionar' : 'Seleccionar' }} Todas
                    </button>
                    
                    @if (selectedConversations().size > 0) {
                      <button
                        class="btn btn-sm btn-success"
                        [disabled]="isUpdatingBot()"
                        (click)="enableBotForSelectedConversations()"
                      >
                        @if (isUpdatingBot()) {
                          <span class="spinner-border spinner-border-sm me-1"></span>
                        } @else {
                          <i class="fas fa-play me-1"></i>
                        }
                        Reactivar Bot ({{ selectedConversations().size }})
                      </button>
                    }
                  </div>
                }
              </div>

              @if (isLoadingDisabledConversations()) {
                <div class="loading-conversations">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  <p>Cargando conversaciones...</p>
                </div>
              } @else if (disabledBotConversations().length === 0) {
                <div class="no-disabled-conversations">
                  <i class="fas fa-check-circle text-success"></i>
                  <p>Â¡Excelente! No hay conversaciones con el bot desactivado.</p>
                  <small class="text-muted">Todas las conversaciones tienen el bot activo.</small>
                </div>
              } @else {
                <div class="conversations-list">
                  @for (conversation of disabledBotConversations(); track conversation.id) {
                    <div class="conversation-item" 
                         [class.selected]="selectedConversations().has(conversation.id)"
                         (click)="toggleConversationSelection(conversation.id)">
                      <div class="conversation-checkbox">
                        <input 
                          type="checkbox" 
                          class="form-check-input"
                          [checked]="selectedConversations().has(conversation.id)"
                          (click)="$event.stopPropagation()"
                          (change)="toggleConversationSelection(conversation.id)"
                        >
                      </div>
                      
                      <div class="conversation-info">
                        <div class="conversation-header">
                          <h6 class="conversation-name">
                            {{ conversation.contact_name || conversation.contact_phone }}
                          </h6>
                          @if (conversation.contact_name) {
                            <small class="conversation-phone text-muted">{{ conversation.contact_phone }}</small>
                          }
                        </div>
                        
                        @if (conversation.last_message) {
                          <p class="conversation-last-message">
                            {{ conversation.last_message }}
                          </p>
                        }
                        
                        <div class="conversation-meta">
                          <small class="text-muted">
                            <i class="fas fa-clock"></i>
                            Ãšltimo mensaje: {{ formatRelativeDate(conversation.last_message_at) }}
                          </small>
                          
                          @if (conversation.unread_count > 0) {
                            <span class="badge bg-danger ms-2">
                              {{ conversation.unread_count }} sin leer
                            </span>
                          }
                        </div>
                      </div>
                      
                      <div class="conversation-status">
                        <span class="badge bg-warning">
                          <i class="fas fa-robot"></i>
                          Bot OFF
                        </span>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="alert alert-danger" role="alert">
          <i class="fas fa-exclamation-triangle"></i>
          {{ errorMessage() }}
        </div>
      }

      <!-- Success Message -->
      @if (successMessage()) {
        <div class="alert alert-success" role="alert">
          <i class="fas fa-check-circle"></i>
          {{ successMessage() }}
        </div>
      }
    }
  </main>

  <!-- WhatsApp Connection Modal -->
  <app-whatsapp-connection-modal
    [isVisible]="showWhatsAppModal()"
    (onClose)="closeWhatsAppModal()"
    (onConnected)="onWhatsAppConnected()"
    (onError)="onWhatsAppError($event)">
  </app-whatsapp-connection-modal>
</div>
